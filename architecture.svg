<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 900" width="100%" height="100%" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, 'Apple Color Emoji', Arial, sans-serif, 'Segoe UI Emoji', 'Segoe UI Symbol'; background: #ffffff;">
  <defs>
    <marker id="arrow-minimal" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#d1d5db" />
    </marker>
    <style>
      .animate-node {
        opacity: 0;
        animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      @keyframes slideUp {
        0% { opacity: 0; transform: translateY(15px); }
        100% { opacity: 1; transform: translateY(0); }
      }
      .delay-1 { animation-delay: 0.1s; }
      .delay-2 { animation-delay: 0.25s; }
      .delay-3 { animation-delay: 0.4s; }
      .delay-4 { animation-delay: 0.55s; }
      .delay-5 { animation-delay: 0.7s; }
      .delay-6 { animation-delay: 0.85s; }
      .flow-line {
        stroke-dasharray: 6 6;
        opacity: 0;
        animation: flow 1.5s linear infinite, fadeIn 0.5s ease-out 0.8s forwards;
      }
      .flow-dash-4 {
        stroke-dasharray: 4 4;
        opacity: 0;
        animation: flow-4 1s linear infinite, fadeIn 0.5s ease-out 0.8s forwards;
      }
      .flow-state {
        stroke-dasharray: 3 5;
        opacity: 0;
        animation: flow-state 2s linear infinite, fadeIn 0.5s ease-out 0.8s forwards;
      }
      @keyframes flow {
        to { stroke-dashoffset: -12; }
      }
      @keyframes flow-4 {
        to { stroke-dashoffset: -8; }
      }
      @keyframes flow-state {
        to { stroke-dashoffset: -16; }
      }
      @keyframes fadeIn {
        to { opacity: 1; }
      }
      .interactive-rect {
        transition: stroke 0.2s ease, fill 0.2s ease;
      }
      .node-group:hover .interactive-rect {
        stroke: #9ca3af;
        fill: #f9fafb;
        cursor: default;
      }
      .core-pulse {
        animation: pulseCore 4s ease-in-out infinite;
      }
      @keyframes pulseCore {
        0% { stroke: #d1d5db; }
        50% { stroke: #6b7280; }
        100% { stroke: #d1d5db; }
      }
    </style>
  </defs>

  <!-- Title -->
  <g class="animate-node" style="animation-delay: 0s;">
    <text x="50" y="60" fill="#37352f" font-size="24" font-weight="600" letter-spacing="-0.5">HPD-Agent Architecture</text>
    <text x="50" y="90" fill="#787774" font-size="14">Execution, Evaluation, and Storage Flow</text>
  </g>

  <g>
    <!-- ═══════════════════════════════════════════════ -->
    <!-- CONNECTIONS                                     -->
    <!-- ═══════════════════════════════════════════════ -->

    <!-- Client App <-> Protocol -->
    <path d="M 180 280 L 230 280" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />
    <path d="M 240 310 L 190 310" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />

    <!-- Protocol <-> HPD Agent -->
    <path d="M 400 280 L 450 280" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />
    <path d="M 460 310 L 410 310" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />

    <!-- Agent -> Observability -->
    <path d="M 570 190 L 570 150" class="flow-dash-4" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />

    <!-- Agent <-> Tool Execution -->
    <path d="M 530 450 L 530 590" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />
    <path d="M 590 600 L 590 460" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />

    <!-- Agent -> Evaluation -->
    <path d="M 680 295 L 730 295" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />

    <!-- Agent <-> Storage (dashed state arrows, going down-left to storage node) -->
    <path d="M 470 450 L 470 465 L 310 465 L 310 495" class="flow-state" fill="none" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrow-minimal)" />
    <path d="M 290 490 L 290 455 L 490 455 L 490 460" class="flow-state" fill="none" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrow-minimal)" />

    <!-- Agent <-> Session/Branch (dashed, right side of agent to session node) -->
    <path d="M 680 340 L 700 340 L 700 530 L 740 530" class="flow-state" fill="none" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrow-minimal)" />
    <path d="M 740 560 L 700 560 L 700 370 L 680 370" class="flow-state" fill="none" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#arrow-minimal)" />

    <!-- Eval -> LLM Judge -->
    <path d="M 830 225 L 830 140 L 960 140" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />

    <!-- Eval -> IScoreStore -->
    <path d="M 920 300 L 960 300" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />

    <!-- Eval -> Annotation Queue -->
    <path d="M 830 375 L 830 460 L 960 460" class="flow-line" fill="none" stroke="#d1d5db" stroke-width="2" marker-end="url(#arrow-minimal)" />

    <!-- Line Labels -->
    <g class="animate-node delay-6">
      <text x="580" y="175" fill="#787774" font-size="12" text-anchor="start">Telemetry</text>
      <text x="705" y="275" fill="#787774" font-size="12" text-anchor="middle">TurnTrace &amp;</text>
      <text x="705" y="290" fill="#787774" font-size="12" text-anchor="middle">Context</text>
      <text x="940" y="290" fill="#787774" font-size="12" text-anchor="middle">ScoreRecord</text>
      <text x="840" y="420" fill="#787774" font-size="12" text-anchor="start" transform="translate(10,0)">Low Score Flag</text>
      <text x="385" y="460" fill="#9ca3af" font-size="11" text-anchor="middle">read / write</text>
      <text x="712" y="520" fill="#9ca3af" font-size="11" text-anchor="middle">state</text>
    </g>

    <!-- ═══════════════════════════════════════════════ -->
    <!-- NODES                                           -->
    <!-- ═══════════════════════════════════════════════ -->

    <!-- User/Client Node -->
    <g transform="translate(40, 235)">
      <g class="animate-node delay-1 node-group">
        <rect class="interactive-rect" width="140" height="120" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="70" y="35" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Client App</text>
        <text x="70" y="52" fill="#787774" font-size="12" text-anchor="middle">(User)</text>
        <rect x="10" y="70" width="120" height="30" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="70" y="90" fill="#37352f" font-size="12" text-anchor="middle">HPD Headless UI</text>
      </g>
    </g>

    <!-- Protocol / Transport Node -->
    <g transform="translate(240, 250)">
      <g class="animate-node delay-2 node-group">
        <rect class="interactive-rect" width="160" height="90" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="80" y="35" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">HPD-Event</text>
        <text x="80" y="52" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Protocol</text>
        <rect x="15" y="65" width="130" height="20" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="80" y="79" fill="#787774" font-size="11" text-anchor="middle">hpd-agent-client</text>
      </g>
    </g>

    <!-- Observability Node -->
    <g transform="translate(460, 70)">
      <g class="animate-node delay-4 node-group">
        <rect class="interactive-rect" width="220" height="70" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="110" y="30" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Observability</text>
        <text x="110" y="48" fill="#787774" font-size="12" text-anchor="middle">OpenTelemetry,</text>
        <text x="110" y="62" fill="#787774" font-size="12" text-anchor="middle">Logs, Metrics</text>
      </g>
    </g>

    <!-- HPD Agent Core -->
    <!-- Expanded height to fit 5 rows + provider list -->
    <g transform="translate(460, 190)">
      <g class="animate-node delay-3 node-group">
        <rect class="interactive-rect core-pulse" width="220" height="260" rx="6" fill="#ffffff" stroke="#d1d5db" stroke-width="2" />
        <text x="110" y="35" fill="#37352f" font-size="16" font-weight="600" text-anchor="middle">HPD Agent</text>

        <rect x="20" y="55" width="180" height="30" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="74" fill="#37352f" font-size="13" text-anchor="middle">Agent Middleware</text>

        <rect x="20" y="95" width="180" height="30" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="114" fill="#37352f" font-size="13" text-anchor="middle">Agentic Loop</text>

        <rect x="20" y="135" width="180" height="30" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="154" fill="#37352f" font-size="13" text-anchor="middle">Audio / Voice I/O</text>

        <!-- LLM Providers row — expanded to show multi-provider -->
        <rect x="20" y="175" width="180" height="68" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="193" fill="#37352f" font-size="12" font-weight="600" text-anchor="middle">LLM Providers</text>
        <text x="110" y="210" fill="#787774" font-size="10.5" text-anchor="middle">OpenAI · Anthropic · Google</text>
        <text x="110" y="224" fill="#787774" font-size="10.5" text-anchor="middle">Azure · Bedrock · Mistral</text>
        <text x="110" y="238" fill="#787774" font-size="10.5" text-anchor="middle">Ollama · ONNX · HuggingFace</text>
      </g>
    </g>

    <!-- Tool Execution -->
    <g transform="translate(460, 610)">
      <g class="animate-node delay-4 node-group">
        <rect class="interactive-rect" width="220" height="260" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="110" y="35" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Tool Execution</text>
        <rect x="20" y="50" width="180" height="28" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="68" fill="#37352f" font-size="12" text-anchor="middle">MCP</text>
        <rect x="20" y="84" width="180" height="28" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="102" fill="#37352f" font-size="12" text-anchor="middle">OpenAPI</text>
        <rect x="20" y="118" width="180" height="28" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="136" fill="#37352f" font-size="12" text-anchor="middle">Native Tool Calling</text>
        <rect x="20" y="152" width="180" height="28" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="170" fill="#37352f" font-size="12" text-anchor="middle">Agent Skills</text>
        <rect x="20" y="186" width="180" height="28" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="204" fill="#37352f" font-size="12" text-anchor="middle">Multi Agents</text>
        <rect x="20" y="220" width="180" height="28" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="110" y="238" fill="#37352f" font-size="12" text-anchor="middle">Sub Agents</text>
      </g>
    </g>

    <!-- Storage Node (IContentStore + ISessionStore) — left of tool execution -->
    <g transform="translate(130, 480)">
      <g class="animate-node delay-4 node-group">
        <rect class="interactive-rect" width="200" height="145" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="100" y="30" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Storage</text>

        <!-- DB icon -->
        <path d="M 65 45 C 65 40, 135 40, 135 45 C 135 50, 65 50, 65 45 Z" fill="#f7f7f5" stroke="#d1d5db" stroke-width="1.2" />
        <path d="M 65 45 L 65 60 C 65 65, 135 65, 135 60 L 135 45" fill="none" stroke="#d1d5db" stroke-width="1.2" />

        <rect x="15" y="75" width="170" height="28" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="100" y="88" fill="#37352f" font-size="12" font-weight="500" text-anchor="middle">ISessionStore</text>
        <text x="100" y="101" fill="#787774" font-size="10" text-anchor="middle">conversation history · branches</text>

        <rect x="15" y="108" width="170" height="28" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="100" y="121" fill="#37352f" font-size="12" font-weight="500" text-anchor="middle">IContentStore</text>
        <text x="100" y="134" fill="#787774" font-size="10" text-anchor="middle">knowledge · memory · artifacts</text>
      </g>
    </g>

    <!-- Session / Branch Node — below evaluation, right of agent -->
    <g transform="translate(740, 510)">
      <g class="animate-node delay-4 node-group">
        <rect class="interactive-rect" width="180" height="110" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="90" y="30" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Session / Branch</text>

        <rect x="15" y="45" width="150" height="25" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="90" y="62" fill="#37352f" font-size="12" text-anchor="middle">Session (metadata, state)</text>

        <rect x="15" y="75" width="150" height="25" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="90" y="89" fill="#37352f" font-size="12" text-anchor="middle">Branch (messages, fork)</text>
      </g>
    </g>

    <!-- Evaluation Middleware -->
    <g transform="translate(740, 225)">
      <g class="animate-node delay-4 node-group">
        <rect class="interactive-rect" width="180" height="150" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="90" y="45" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Evaluation</text>
        <rect x="15" y="65" width="150" height="25" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="90" y="82" fill="#37352f" font-size="12" text-anchor="middle">Event Observer</text>
        <rect x="15" y="100" width="150" height="25" rx="4" fill="#f7f7f5" stroke="#e5e7eb" stroke-width="1" />
        <text x="90" y="117" fill="#37352f" font-size="12" text-anchor="middle">Metric Aggregator</text>
      </g>
    </g>

    <!-- Judge LLM -->
    <g transform="translate(970, 100)">
      <g class="animate-node delay-5 node-group">
        <rect class="interactive-rect" width="200" height="80" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="100" y="30" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Judge LLM</text>
        <text x="100" y="48" fill="#787774" font-size="12" text-anchor="middle">LlmJudgeEvaluator</text>
        <text x="100" y="62" fill="#787774" font-size="12" text-anchor="middle">DecomposeVerifyEvaluator</text>
      </g>
    </g>

    <!-- IScoreStore -->
    <g transform="translate(970, 250)">
      <g class="animate-node delay-5 node-group">
        <rect class="interactive-rect" width="200" height="100" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <path class="interactive-rect" d="M 60 25 C 60 20, 140 20, 140 25 C 140 30, 60 30, 60 25 Z" fill="#f7f7f5" stroke="#d1d5db" stroke-width="1.5" />
        <path class="interactive-rect" d="M 60 25 L 60 45 C 60 50, 140 50, 140 45 L 140 25" fill="none" stroke="#d1d5db" stroke-width="1.5" />
        <text x="100" y="70" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">IScoreStore</text>
        <text x="100" y="88" fill="#787774" font-size="12" text-anchor="middle">Metrics, Trends, Reports</text>
      </g>
    </g>

    <!-- Annotation Queue -->
    <g transform="translate(970, 420)">
      <g class="animate-node delay-5 node-group">
        <rect class="interactive-rect" width="200" height="80" rx="6" fill="#ffffff" stroke="#e5e7eb" stroke-width="1.5" />
        <text x="100" y="35" fill="#37352f" font-size="14" font-weight="600" text-anchor="middle">Annotation Queue</text>
        <text x="100" y="55" fill="#787774" font-size="12" text-anchor="middle">Human-in-the-loop Review</text>
      </g>
    </g>

  </g>
</svg>
