using System;
using System.Threading.Tasks;
using Microsoft.Extensions.AI;

namespace HPD.Agent.Toolkits.FileSystem.Examples;

/// <summary>
/// Example usage of the FileSystemToolkit with HPD-Agent
/// </summary>
public static class FileSystemToolkitExamples
{
    /// <summary>
    /// Example 1: Basic setup and registration
    /// </summary>
    public static async Task BasicSetupExample()
    {
        // 1. Create a context for your workspace
        var context = new FileSystemContext(
            workspaceRoot: "/path/to/your/project",
            allowOutsideWorkspace: false,      // Keep operations safe
            respectGitIgnore: true,
            maxFileSize: 10_000_000,           // 10 MB max
            enableSearch: true
        );

        // 2. Create Toolkit manager and register the Toolkit
        var ToolkitManager = new ToolkitManager(context);
        ToolkitManager.RegisterToolkit<FileSystemToolkit>();

        // 3. Create AI functions
        var functions = ToolkitManager.CreateAllFunctions(context);

        Console.WriteLine($"Registered {functions.Count} AI functions:");
        foreach (var func in functions)
        {
            Console.WriteLine($"  - {func.Metadata.Name}");
        }

        // 4. Use with your AI chat client
        // chatClient.Tools = functions;
        // var response = await chatClient.CompleteAsync("Read the README.md file");
    }

    /// <summary>
    /// Example 2: Code search and refactoring
    /// </summary>
    public static async Task CodeSearchExample()
    {
        var context = new FileSystemContext("/workspace");
        var Toolkit = new FileSystemToolkit(context);

        // Find all C# files
        Console.WriteLine("Finding all C# files...");
        var files = await Toolkit.FindFiles("**/*.cs");
        Console.WriteLine(files);

        // Search for TODO comments
        Console.WriteLine("\nSearching for TODO comments...");
        var todos = await Toolkit.SearchContent("TODO", filePattern: "*.cs");
        Console.WriteLine(todos);

        // Search for specific pattern with regex
        Console.WriteLine("\nSearching for class definitions...");
        var classes = await Toolkit.SearchContent(@"public class \w+", filePattern: "**/*.cs");
        Console.WriteLine(classes);
    }

    /// <summary>
    /// Example 3: File editing with diff preview
    /// </summary>
    public static async Task FileEditingExample()
    {
        var context = new FileSystemContext("/workspace");
        var Toolkit = new FileSystemToolkit(context);

        // Read a file
        var content = await Toolkit.ReadFile("/workspace/src/Program.cs");
        Console.WriteLine("Original content:");
        Console.WriteLine(content);

        // Edit the file (requires permission)
        var result = await Toolkit.EditFile(
            filePath: "/workspace/src/Program.cs",
            oldString: "var oldVariable = 123;",
            newString: "var newVariable = 456;"
        );

        Console.WriteLine("\nEdit result with diff:");
        Console.WriteLine(result);
    }

    /// <summary>
    /// Example 4: Directory browsing and file operations
    /// </summary>
    public static async Task DirectoryBrowsingExample()
    {
        var context = new FileSystemContext("/workspace");
        var Toolkit = new FileSystemToolkit(context);

        // List directory contents
        var listing = await Toolkit.ListDirectory("/workspace/src", recursive: false);
        Console.WriteLine(listing);

        // List recursively
        var recursiveListing = await Toolkit.ListDirectory("/workspace", recursive: true);
        Console.WriteLine(recursiveListing);

        // Read a file with line range (for large files)
        var partialContent = await Toolkit.ReadFile(
            absolutePath: "/workspace/logs/app.log",
            offset: 100,    // Start at line 100
            limit: 50       // Read 50 lines
        );
        Console.WriteLine(partialContent);
    }

    /// <summary>
    /// Example 5: Agent-powered documentation generator
    /// </summary>
    public static async Task DocumentationGeneratorExample(IChatClient chatClient)
    {
        var context = new FileSystemContext("/workspace");
        var ToolkitManager = new ToolkitManager(context);
        ToolkitManager.RegisterToolkit<FileSystemToolkit>();

        var functions = ToolkitManager.CreateAllFunctions(context);

        // Configure chat client with tools
        var chatOptions = new ChatOptions
        {
            Tools = functions
        };

        // Agent can now use file system operations
        var messages = new[]
        {
            new ChatMessage(ChatRole.User,
                "Generate API documentation by reading all files in src/Controllers/ and create a docs/API.md file")
        };

        var response = await chatClient.CompleteAsync(messages, chatOptions);
        Console.WriteLine(response);

        // The agent will:
        // 1. Call FindFiles("src/Controllers/**/*.cs")
        // 2. Call ReadFile for each controller
        // 3. Generate documentation
        // 4. Call WriteFile("docs/API.md", content)
    }

    /// <summary>
    /// Example 6: Context-aware Toolkit (disable search for security)
    /// </summary>
    public static void ContextAwareExample()
    {
        // Production context - search disabled for security
        var prodContext = new FileSystemContext(
            workspaceRoot: "/production/app",
            allowOutsideWorkspace: false,
            enableSearch: false  // FindFiles and SearchContent won't be available
        );

        var ToolkitManager = new ToolkitManager(prodContext);
        ToolkitManager.RegisterToolkit<FileSystemToolkit>();

        var functions = ToolkitManager.CreateAllFunctions(prodContext);

        // FindFiles and SearchContent won't be in the function list
        Console.WriteLine($"Available functions: {string.Join(", ", functions.Select(f => f.Metadata.Name))}");
        // Output: ReadFile, WriteFile, ListDirectory, EditFile (no FindFiles, no SearchContent)
    }

    /// <summary>
    /// Example 7: Custom workspace validation
    /// </summary>
    public static async Task WorkspaceValidationExample()
    {
        var context = new FileSystemContext(
            workspaceRoot: "/safe/workspace",
            allowOutsideWorkspace: false  // Enforce workspace boundaries
        );

        var Toolkit = new FileSystemToolkit(context);

        //  Allowed: Inside workspace
        var result1 = await Toolkit.ReadFile("/safe/workspace/file.txt");
        Console.WriteLine(result1);

        //    Blocked: Outside workspace
        var result2 = await Toolkit.ReadFile("/etc/passwd");
        Console.WriteLine(result2);  // Error: File path must be within workspace

        //    Blocked: Path traversal attempt
        var result3 = await Toolkit.ReadFile("/safe/workspace/../../etc/passwd");
        Console.WriteLine(result3);  // Error: File path must be within workspace
    }
}

/// <summary>
/// Integration example with a complete agent setup
/// </summary>
public class CompleteAgentExample
{
    public static async Task RunAgent()
    {
        // 1. Setup workspace context
        var fsContext = new FileSystemContext(
            workspaceRoot: Directory.GetCurrentDirectory(),
            enableSearch: true
        );

        // 2. Register all Toolkits
        var ToolkitManager = new ToolkitManager(fsContext);
        ToolkitManager.RegisterToolkit<FileSystemToolkit>();
        // ToolkitManager.RegisterToolkit<WebSearchToolkit>(); // Add other Toolkits

        // 3. Create functions
        var tools = ToolkitManager.CreateAllFunctions(fsContext);

        // 4. Setup AI client (example with your agent)
        // var chatClient = new YourChatClient(...);

        // 5. Run agent with tools
        // var options = new ChatOptions { Tools = tools };
        // var response = await chatClient.CompleteAsync(
        //     "Analyze all TypeScript files and create a summary in ANALYSIS.md",
        //     options
        // );

        Console.WriteLine($"Agent configured with {tools.Count} file system tools");
    }
}
